#
# Copyright (c) 2025 Dynatrace Open Source
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the Software), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in all
# copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#
# DASHBOARD: DSOA Self Monitoring
# DESCRIPTION:  Self-monitoring dashboard for Dynatrace Snowflake Open Source Agent (DSOA).
# OWNER: sebastian.kruk
# PLUGINS: query_history
# TAGS: self-monitoring
#
version: 19
variables:
  - key: Accounts
    version: 2
    type: query
    visible: true
    editable: true
    input: |-
      fetch logs
      | filter db.system == "snowflake"
      | fields deployment.environment
      | dedup deployment.environment
      | sort deployment.environment
    multiple: true
    defaultValue:
      - 3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*
  - key: Plugin_Names
    visible: true
    type: query
    version: 2
    editable: true
    input: |-
      fetch logs
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "query_history"
      | filter in(deployment.environment, array($Accounts))
      | filter matchesPattern(db.query.text,
          """'call DTAGENT' ('_' LD:tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'""")
      | parse `db.query.text`, """'call DTAGENT' ('_' LD:env_tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'"""
      | expand plugin_name = plugin_names
      | fields plugin_name
      | dedup plugin_name
      | sort plugin_name
    multiple: true
    defaultValue:
      - 3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*
  - key: Plugin_Contexts
    visible: true
    type: query
    version: 2
    editable: true
    input: |-
      fetch logs
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "query_history"
      | filter in(deployment.environment, array($Accounts))
      | filter matchesPattern(db.query.text,
          """'call DTAGENT' ('_' LD:tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'""")
      | parse `db.query.text`, """'call DTAGENT' ('_' LD:env_tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'"""
      | expand plugin_name = plugin_names
      | fields plugin_name
      | filter in(plugin_name, array($Plugin_Names))
      | dedup plugin_name
      | join [
        data json:"""[
          {
              "plugin_name": "dynamic_tables",
              "contexts": [
                  "dynamic_tables",
                  "dynamic_table_refresh_history",
                  "dynamic_table_graph_history"
              ]
          },
          {
              "plugin_name": "event_log",
              "contexts": [
                  "event_log",
                  "event_log_metrics",
                  "event_log_spans"
              ]
          },
          {
              "plugin_name": "login_history",
              "contexts": [
                  "login_history",
                  "sessions"
              ]
          },
          {
              "plugin_name": "shares",
              "contexts": [
                  "shares",
                  "outbound_shares",
                  "inbound_shares"
              ]
          },
          {
              "plugin_name": "tasks",
              "contexts": [
                  "serverless_tasks",
                  "task_versions",
                  "task_history"
              ]
          },
          {
              "plugin_name": "warehouse_usage",
              "contexts": [
                  "warehouse_usage",
                  "warehouse_usage_load",
                  "warehouse_usage_metering"
              ]
          }
        ]"""
      ]
      , on:{plugin_name}
      , fields: {contexts}
      , kind: leftOuter
      | fields contexts = coalesce(contexts, array(plugin_name))
      | expand context = contexts
      | fields context
      | dedup  context
      | sort context
    multiple: true
    defaultValue:
      - 3420b2ac-f1cf-4b24-b62d-61ba1ba8ed05*
tiles:
  "1":
    title: Plugin execution time (bizevents)
    type: data
    query: |-
      fetch bizevents
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "self_monitoring"
      | filter in(deployment.environment, array($Accounts))
      | filter in(dsoa.task.name, array($Plugin_Names))
      | sort timestamp asc
      | summarize {
          timestamp = takeFirst(timestamp),
          dsoa.run.duration = max(timestamp) - min(timestamp),
          count = count()
      }, by: {
          deployment.environment,
          deployment.environment.tag = env_tag,
          dsoa.task.exec.id,
          dsoa.task.name
      }
      | filter count > 1
      | makeTimeseries {
          dsoa.run.duration = sum(dsoa.run.duration)
      }, by: {
          dsoa.run.context = dsoa.task.name
      }
    visualization: lineChart
    visualizationSettings:
      chartSettings:
        truncationMode: middle
        xAxisLabel: timeframe
        xAxisScaling: auto
        fieldMapping:
          leftAxisValues:
            - dsoa.run.duration
          timestamp: timeframe
        curve: smooth
        gapPolicy: connect
      dataMapping:
        displayedFields:
          - dsoa.run.context
      thresholds: []
      unitsOverrides:
        - identifier: snowagent.run.duration
          unitCategory: time
          baseUnit: nanosecond
          displayUnit: null
          decimals: 2
          suffix: ""
          delimiter: false
          added: 1727938388826
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "2":
    title: Failed plugin executions
    type: data
    query: |
      fetch logs
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "query_history"
      | filter in(deployment.environment, array($Accounts))
      | filter snowflake.query.execution_status != "SUCCESS"
      | filter matchesPattern(db.query.text,
          """'call DTAGENT' ('_' LD:tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'""")
      | parse `db.query.text`, """'call DTAGENT' ('_' LD:env_tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'"""
      | expand plugin_name = plugin_names
      | fields plugin_name, timestamp, snowflake.query.execution_status
      | makeTimeseries count(), by: {
          plugin_name, snowflake.query.execution_status
      }
    visualization: barChart
    visualizationSettings:
      chartSettings:
        truncationMode: middle
        xAxisLabel: timeframe
        xAxisScaling: analyzedTimeframe
        fieldMapping:
          leftAxisValues:
            - count()
          timestamp: timeframe
      thresholds: []
      unitsOverrides:
        - identifier: sum(snowflake.total_elapsed_time)
          unitCategory: time
          baseUnit: millisecond
          displayUnit: null
          decimals: 2
          suffix: ""
          delimiter: false
          added: 1727938388826
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "3":
    title: Plugin execution count
    type: data
    query: |-
      fetch bizevents
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "self_monitoring"
      | filter in(deployment.environment, array($Accounts))
      | filter in(dsoa.task.name, array($Plugin_Names))
      | sort timestamp asc
      | summarize {
          count = count()
      }, by: {
          deployment.environment,
          dsoa.task.exec.id,
          dsoa.task.name
      }
      | filter count > 1
      | summarize {
          dsoa.run.duration = count()
      }, by: {
          dsoa.run.context = dsoa.task.name
      }
    visualization: honeycomb
    visualizationSettings:
      honeycomb:
        colorMode: color-palette
        colorPalette: blue
        dataMappings:
          value: dsoa.run.duration
        displayedFields:
          - dsoa.run.context
        legend:
          position: right
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "4":
    title: Plugin total elapse time
    type: data
    query: |-
      fetch bizevents
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "self_monitoring"
      | filter in(deployment.environment, array($Accounts))
      | filter in(dsoa.task.name, array($Plugin_Names))
      | sort timestamp asc
      | summarize {
        dsoa.run.duration = takeLast(timestamp) - takeFirst(timestamp),
        count = count()
      }, by: {
        deployment.environment,
        dsoa.task.exec.id,
        dsoa.task.name
      }
      | filter count > 1
      | summarize {
        dsoa.run.duration = sum(dsoa.run.duration)
      }, by: {
        dsoa.run.context = dsoa.task.name
      }
    visualization: honeycomb
    visualizationSettings:
      honeycomb:
        colorMode: color-palette
        colorPalette: orange
        dataMappings:
          value: dsoa.run.duration
        displayedFields:
          - dsoa.run.context
        legend:
          position: right
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "5":
    title: Log lines produced per data type
    type: data
    query: |
      fetch logs
      | filter db.system == "snowflake"
      | filter in(deployment.environment, array($Accounts))
      | filter in(dsoa.run.context, array($Plugin_Contexts))
      | summarize by: {
          plugin_name = dsoa.run.context
      }, {
          count()
      }
    visualization: honeycomb
    visualizationSettings:
      honeycomb:
        legend:
          position: right
        dataMappings:
          value: count()
        displayedFields:
          - plugin_name
        colorPalette: blue
      thresholds: []
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "8":
    title: Plugin executions
    type: data
    query: |-
      fetch bizevents
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "self_monitoring"
      | filter in(deployment.environment, array($Accounts))
      | filter in(dsoa.task.name, array($Plugin_Names))
      | sort timestamp desc
      | fields timestamp, dsoa.task.name, deployment.environment
      | limit 50
    visualization: table
    visualizationSettings:
      table:
        columnWidths:
          '["deployment.environment"]': 132.984375
      thresholds: []
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "9":
    title: Accounts
    type: data
    query: |-
      fetch logs
      | filter db.system == "snowflake"
      | filter in(deployment.environment, array($Accounts))
      | summarize by: {
          deployment.environment, host.name
      }, {
          count()
      }
    visualization: honeycomb
    visualizationSettings:
      honeycomb:
        shape: square
        dataMappings:
          value: count()
        displayedFields:
          - deployment.environment
        colorPalette: blue
      thresholds: []
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
  "10":
    title: Query execution time by plugin
    type: data
    query: |-
      fetch logs
      | filter db.system == "snowflake"
      | filter dsoa.run.context == "query_history"
      | filter in(deployment.environment, array($Accounts))
      | filter matchesPattern(db.query.text,
          """'call DTAGENT' ('_' LD:tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'""")
      | parse `db.query.text`, """'call DTAGENT' ('_' LD:env_tag)?  '_DB.APP.DTAGENT(ARRAY_CONSTRUCT(' ARRAY{SQS:plugin_name ', '?}{1,}:plugin_names '))'"""
      | fieldsAdd plugins_count = arraySize(plugin_names)
      | expand plugin_name = plugin_names
      | filter in(plugin_name, array($Plugin_Names))
      | fields plugin_name, timestamp, snowflake.query.execution_status,
        snowflake.time.total_elapsed = toLong(snowflake.time.total_elapsed) / plugins_count,
        snowflake.time.execution = toLong(snowflake.time.execution) / plugins_count,
        snowflake.time.compilation = toLong(snowflake.time.compilation) / plugins_count
      | makeTimeseries sum(snowflake.time.total_elapsed), by: {
          plugin_name
      }
    visualization: lineChart
    visualizationSettings:
      chartSettings:
        truncationMode: middle
        xAxisLabel: timeframe
        xAxisScaling: auto
        fieldMapping:
          leftAxisValues:
            - sum(snowflake.time.total_elapsed)
          timestamp: timeframe
        curve: smooth
        gapPolicy: connect
      dataMapping:
        displayedFields:
          - plugin_name
      thresholds: []
      unitsOverrides:
        - identifier: sum(snowflake.time.total_elapsed)
          unitCategory: time
          baseUnit: millisecond
          displayUnit: null
          decimals: 2
          suffix: ""
          delimiter: false
          added: 1727938388826
      legend:
        showLegend: false
        position: auto
        ratio: 10
    querySettings:
      maxResultRecords: 1000
      defaultScanLimitGbytes: 500
      maxResultMegaBytes: 1
      defaultSamplingRatio: 10
      enableSampling: false
    davis:
      enabled: false
      davisVisualization:
        isAvailable: true
      componentState:
        inputData: null
layouts:
  "1":
    x: 0
    "y": 7
    w: 24
    h: 6
  "2":
    x: 0
    "y": 19
    w: 15
    h: 6
  "3":
    x: 18
    "y": 0
    w: 6
    h: 7
  "4":
    x: 11
    "y": 0
    w: 7
    h: 7
  "5":
    x: 3
    "y": 0
    w: 8
    h: 7
  "8":
    x: 15
    "y": 19
    w: 9
    h: 6
  "9":
    x: 0
    "y": 0
    w: 3
    h: 7
  "10":
    x: 0
    "y": 13
    w: 24
    h: 6
importedWithCode: false
settings:
  defaultTimeframe:
    value:
      from: now()-24h
      to: now()
    enabled: true
