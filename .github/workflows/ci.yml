name: Quality Checks

on:
  push:
    branches: ["devel", "main", "dev/*", "release/*", "feature/*", "hotfix/*"]
  pull_request:
    branches: ["devel", "main", "dev/*", "release/*", "feature/*", "hotfix/*"]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install flake8 black sqlfluff yamllint pylint
          npm install -g markdownlint-cli

      - name: Lint Python
        run: flake8 src/ test/ || exit 1

      - name: Format Python
        run: black --check src/ test/ || exit 1

      - name: Pylint Python
        run: |
          pylint src/
          pylint test/

      - name: Lint SQL
        run: sqlfluff lint src/*.sql --ignore parsing --disable-progress-bar || exit 1

      - name: Lint YAML
        run: yamllint src || exit 1

      - name: Lint Markdown
        run: markdownlint '**/*.md' || exit 1

  test-documentation:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run TestDocumentation tests
        run: pytest test/core/test_documentation.py -k "TestDocumentation"

  test-bash:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Bats
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Install jq (required by some tests)
        run: sudo apt-get install -y jq

      - name: Run bash tests
        run: ./test/bash/run_tests.sh

  test-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Git LFS
        run: git lfs install

      - name: Pull LFS objects
        run: git lfs pull

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-mock

      - name: Install Bats (for bash tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y bats jq

      - name: Run core tests
        run: |
          pytest test/core/test_config.py -k "TestConfig"
          pytest test/core/test_util.py -k "TestUtil"
          pytest test/core/test_views_structure.py -k "TestViews"
          pytest test/core/test_connector.py -k "TestTelemetrySender"
          pytest test/core/test_bash_scripts.py -k "test_bash_scripts"
      - name: Run OTEL tests
        run: |
          pytest test/otel/test_events.py -k "TestEvents"
          pytest test/otel/test_otel_manager.py -k "TestOtelManager"

  test-plugins:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Git LFS
        run: git lfs install

      - name: Pull LFS objects
        run: git lfs pull

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install pytest-mock

      - name: Install Bats (for bash tests)
        run: |
          sudo apt-get update
          sudo apt-get install -y bats jq

      - name: Run plugin tests
        run: pytest test/plugins/
